<html lang="en">
   <head>
      {% include 'head.html' %}
       <title>Collaborate - {{collab_id}}</title>
    
   </head>
   <body>
      <canvas id="canvas" style="position: relative;" height="600" width="700"></canvas>
      <div class="tools">
      <div title="square"><i class="fi fi-sr-square"></i></div>
      <div title="circle"><i class="fi fi-sr-circle"></i></div>
      <div title="triangle"><i class="fi fi-sr-triangle"></i></div>
      <div title="pencil"><i class="fi fi-sr-pen-swirl"></i></div>
     
      <div title="stroke">
         <i class="fi fi-sr-line-width"></i>
         <div class="lines" style="display: none;">
            <div style="border:1px solid #000;" title="1">1px</div>
            <div style="border:1px solid #000;" title="2">2px</div>
            <div style="border:1px solid #000;" title="3">3px</div>
            <div style="border:1px solid #000;" title="4">4px</div>
            <div style="border:1px solid #000;" title="5">5px</div>
         </div>
      </div>
      <div title="font"><i class="fi fi-sr-text"></i></div>
      <div title="fill" style="position: relative;">
         <i class="fi fi-sr-palette"></i>
         <div class="colors" style="display: none;">
            <div style="background-color: #582B11;" title="#582B11"></div>
            <div style="background-color: #AF125A;" title="#AF125A"></div>
            <div style="background-color: #4F6D7A;" title="#4F6D7A"></div>
            <div style="background-color: #DD6E42;" title="#DD6E42"></div>
            <div style="background-color: #379634;" title="#379634"></div>
            <div style="background-color: #201E1F;" title="#201E1F"></div>
            <div style="background-color: #a8d0e6;" title="#a8d0e6"></div>
            <div style="background-color: #FF4000;" title="#FF4000"></div>
            <div style="background-color: #50B2C0;" title="#50B2C0"></div>
            <div style="background-color: #ffffff;" title="#DCED31"></div>
            <div style="background-color: #0CCE6B;" title="#0CCE6B"></div>
            <div style="background-color: #363537;" title="#363537"></div>
            <div style="background-color: #2E5077;" title="#2E5077"></div>
            <div style="background-color: #000000;" title="#000000"></div>
            <div style="background-color: #FFE347;" title="#FFE347"></div>
            <div style="background-color: #6457A6;" title="#6457A6"></div>
         </div>
      </div> <div title="delete"><i class="fi fi-sr-trash"></i></div>
      <p class="fill" hidden>#ffffff</p>
      <p class="stroke" hidden>#000000</p>
      <p class="stroke_" hidden>1</p>
      <script>
         $(document).ready(function () {
          $(".colors>div").click(function(){
         var c=$(this).attr("title");console.log(c);
         $(".fill").text(c);
          });          $(".lines>div").click(function(){
         var c=$(this).attr("title");console.log(c);
         $(".stroke_").text(c);
          });
            $(".tools > div").click(function () {
               $(".tools > div").css({ "background": "#fff" });
               $(this).css({ "background": "#efefef" });
            });
         });
         
         var data;
         const can = document.getElementById("canvas");
         $(can).attr("height", window.innerHeight);
         $(can).attr("width", window.innerWidth);
         
         const canvas = new fabric.Canvas(can, {
            isDrawingMode: false,  // Initially drawing mode is off
         });
         
         fabric.Object.ownDefaults.transparentCorners = false;
         
         $(".tools > div").click(function () {
            data = $(this).attr("title");
            var width = 200;
            var height = 200;
            var left = (window.innerWidth-200)/2;
            var top = (window.innerHeight-200)/2;
            var angle = 0;
            var fill = $(".fill").text();
            var stroke = $(".stroke").text();
            var strokeWidth = parseInt($(".stroke_").text());
         
            var commonConfig = {
               left: left,
               top: top,
               angle: angle,
               fill: fill,
               stroke: stroke,
               strokeWidth: strokeWidth
            };
            canvas.isDrawingMode = false;
            switch (data) {
              
               case "square":
                canvas.isDrawingMode = false;
                  canvas.add(new fabric.Rect({
                     width: width,
                     height: height,
                     ...commonConfig
                  }));
                  break;
         
               case "circle":
                  canvas.add(new fabric.Circle({
                     radius: 50,
                     ...commonConfig
                  }));
                  break;
         
               case "triangle":
                  canvas.add(new fabric.Triangle({
                     width: width,
                     height: height,
                     ...commonConfig
                  }));
                  break;
         
                  case "font":
   canvas.add(new fabric.Textbox('Add Your Text Here', {
      left: left,
      top: top,
      width: width,
      fontSize: 30,
      editable: true,
      backgroundColor: 'transparent',
      borderColor: 'gray',
      fontFamily: 'Courier Prime', // Custom font
      fill: 'black'
   }));
   break;

         
               case "pencil":
                  canvas.isDrawingMode = true;
                  const pencilBrush = new fabric.PencilBrush(canvas);
                  pencilBrush.color = $(".stroke").text();
                  pencilBrush.width = parseInt($(".stroke_").text());
                  canvas.freeDrawingBrush = pencilBrush;
         
                  break;
                  case "fill":
                    $(".colors").toggle();
                    break;
                    case "stroke":
                    $(".lines").toggle();
                    break;
                    case "delete":
   var selectedObject = canvas.getActiveObject();
   if (selectedObject) {
       canvas.remove(selectedObject);
       canvas.discardActiveObject();
       canvas.renderAll();
   } else {
       alert("No object selected for deletion.");
   }
   break;

            }
         });
         
         canvas.on({
            'object:moving': onChange,
            'object:scaling': onChange,
            'object:rotating': onChange,
            'object:skewing': onChange,
         });
         
         const hit = new fabric.Circle({
            radius: 5,
            originX: 'center',
            originY: 'center',
            opacity: 0.5,
         });
         
         function onChange({ target }) {
            target.setCoords();
            const ctx = canvas.getTopContext();
            canvas.clearContext(ctx);
            canvas.forEachObject((obj) => {
               if (obj === target) {
                  obj.set('opacity', 1);
                  return;
               }
               const intersection = fabric.Intersection.intersectPolygonPolygon(
                  target.getCoords(true),
                  obj.getCoords(true)
               );
         
               hit.set({ fill: obj.fill });
               if (
                  intersection.status === 'Intersection' ||
                  intersection.status === 'Coincident' ||
                  obj.isContainedWithinObject(target, true) ||
                  target.isContainedWithinObject(obj, true)
               ) {
                  obj.set('opacity', 1);
                  ctx.save();
                  ctx.transform(...canvas.viewportTransform);
                  hit.transform(ctx);
                  intersection.points.forEach(({ x, y }) => {
                     ctx.save();
                     ctx.translate(x, y);
                     hit._render(ctx);
                     ctx.restore();
                  });
                  ctx.restore();
               } else {
                  obj.set('opacity', 1);
               }
            });
         }
      </script>
   </body>
</html>
